name: Multi-Platform Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: pacman-linux
            asset_ext: .tar.gz
            install_cmd: sudo apt-get update && sudo apt-get install -y libsfml-dev libx11-dev libxrandr-dev libudev-dev libgl1-mesa-dev libfreetype6-dev libopenal-dev libflac-dev libvorbis-dev
            
          - os: windows-latest
            artifact_name: pacman-windows
            asset_ext: .zip
            install_cmd: echo "Windows dependencies managed by VCPKG"
            
          - os: macos-latest
            artifact_name: pacman-macos
            asset_ext: .tar.gz
            install_cmd: brew install sfml@2

    steps:
      # 1. Code ophalen
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Afhankelijkheden installeren (Linux & Mac)
      - name: Install Dependencies (Linux/Mac)
        if: runner.os != 'Windows'
        run: ${{ matrix.install_cmd }}

      # 3a. VCPKG Terugzetten (Windows FIX voor SFML 3 issue)
      # We zetten VCPKG terug naar de release van november 2024, toen SFML nog op versie 2.6.x zat.
      - name: Pin VCPKG Version (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cd "$VCPKG_INSTALLATION_ROOT"
          git checkout 2024.11.16

      # 3b. Setup VCPKG (Alleen Windows)
      - name: Setup VCPKG (Windows)
        if: runner.os == 'Windows'
        run: vcpkg install sfml:x64-windows

      # 4. CMake Configureren
      - name: Configure CMake
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
          else
            if [ "$RUNNER_OS" == "macOS" ]; then
               export CMAKE_PREFIX_PATH="/opt/homebrew/opt/sfml@2:$CMAKE_PREFIX_PATH"
            fi
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          fi

      # 5. Bouwen
      - name: Build
        run: cmake --build build --config Release

      # 6. Dist map voorbereiden (Algemeen)
      - name: Prepare Dist Folder
        run: |
          mkdir dist
          if [ -d "assets" ]; then cp -r assets dist/; fi

      # 7a. Package Windows (Exe + DLLs)
      - name: Package Windows
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cp build/Release/*.exe dist/
          find build -name "*.dll" -exec cp {} dist/ \;
          cd dist
          7z a ../${{ matrix.artifact_name }}${{ matrix.asset_ext }} *

      # 7b. Package macOS (Fix voor permissies)
      - name: Package macOS
        if: runner.os == 'macOS'
        shell: bash
        run: |
          # Op Mac gebruiken we -perm +111 om executables te vinden (standaard BSD syntax)
          find build -maxdepth 3 -type f -perm +111 -not -path '*/.*' -exec cp {} dist/ \;
          cd dist
          tar -czvf ../${{ matrix.artifact_name }}${{ matrix.asset_ext }} *

      # 7c. Package Linux (Standaard executable)
      - name: Package Linux
        if: runner.os == 'Linux'
        shell: bash
        run: |
          find build -maxdepth 3 -type f -executable -not -path '*/.*' -exec cp {} dist/ \;
          cd dist
          tar -czvf ../${{ matrix.artifact_name }}${{ matrix.asset_ext }} *

      # 8. Uploaden naar GitHub Releases
      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.artifact_name }}${{ matrix.asset_ext }}
