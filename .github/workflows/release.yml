name: Multi-Platform Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # FASE 1: BOUWEN (3x Parallel)
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: pacman-linux
            asset_ext: .tar.gz
            install_cmd: sudo apt-get update && sudo apt-get install -y libsfml-dev libx11-dev libxrandr-dev libudev-dev libgl1-mesa-dev libfreetype6-dev libopenal-dev libflac-dev libvorbis-dev
            
          - os: windows-latest
            artifact_name: pacman-windows
            asset_ext: .zip
            install_cmd: echo "Windows dependencies managed by VCPKG"
            
          - os: macos-latest
            artifact_name: pacman-macos
            asset_ext: .tar.gz
            install_cmd: brew install sfml@2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies (Linux/Mac)
        if: runner.os != 'Windows'
        run: ${{ matrix.install_cmd }}

      - name: Pin VCPKG Version (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cd "$VCPKG_INSTALLATION_ROOT"
          git checkout 2024.11.16

      - name: Setup VCPKG (Windows)
        if: runner.os == 'Windows'
        run: vcpkg install sfml:x64-windows

      - name: Configure CMake
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
          else
            if [ "$RUNNER_OS" == "macOS" ]; then
               export CMAKE_PREFIX_PATH="/opt/homebrew/opt/sfml@2:$CMAKE_PREFIX_PATH"
            fi
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          fi

      - name: Build
        run: cmake --build build --config Release

      - name: Prepare Dist Folder
        run: |
          mkdir dist
          if [ -d "assets" ]; then cp -r assets dist/; fi

      - name: Package Windows
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cp build/Release/*.exe dist/
          find build -name "*.dll" -exec cp {} dist/ \;
          cd dist
          7z a ../${{ matrix.artifact_name }}${{ matrix.asset_ext }} *

      - name: Package macOS
        if: runner.os == 'macOS'
        shell: bash
        run: |
          find build -maxdepth 3 -type f -perm +111 -not -path '*/.*' -exec cp {} dist/ \;
          cd dist
          tar -czvf ../${{ matrix.artifact_name }}${{ matrix.asset_ext }} *

      - name: Package Linux
        if: runner.os == 'Linux'
        shell: bash
        run: |
          find build -maxdepth 3 -type f -executable -not -path '*/.*' -exec cp {} dist/ \;
          cd dist
          tar -czvf ../${{ matrix.artifact_name }}${{ matrix.asset_ext }} *

      # BELANGRIJK: Hier uploaden we naar tijdelijke GitHub opslag in plaats van direct releasen
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}${{ matrix.asset_ext }}
          if-no-files-found: error

  # FASE 2: RELEASEN (1x, pas als alles klaar is)
  release:
    name: Create Release
    needs: build  # Wacht tot alle build jobs klaar zijn
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          # Download alles van de vorige stap
          path: artifacts
          merge-multiple: true

      - name: List files (Debug)
        run: ls -R artifacts

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
