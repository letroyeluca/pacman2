name: Multi-Platform Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: pacman-linux
            asset_ext: .tar.gz
            # Linux installeert distro-versie (meestal 2.5/2.6, dat is OK)
            install_cmd: sudo apt-get update && sudo apt-get install -y libsfml-dev libx11-dev libxrandr-dev libudev-dev libgl1-mesa-dev libfreetype6-dev libopenal-dev libflac-dev libvorbis-dev
            
          - os: windows-latest
            artifact_name: pacman-windows
            asset_ext: .zip
            # Windows commando is leeg hier, we doen dit in de steps
            install_cmd: echo "Windows dependencies managed by VCPKG"
            
          - os: macos-latest
            artifact_name: pacman-macos
            asset_ext: .tar.gz
            # FIX: Specifiek versie 2 installeren op Mac!
            install_cmd: brew install sfml@2

    steps:
      # 1. Code ophalen
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Afhankelijkheden installeren (Linux & Mac)
      - name: Install Dependencies (Linux/Mac)
        if: runner.os != 'Windows'
        run: ${{ matrix.install_cmd }}

      # 3. Setup VCPKG (Alleen Windows)
      - name: Setup VCPKG (Windows)
        if: runner.os == 'Windows'
        run: vcpkg install sfml:x64-windows

      # 4. CMake Configureren
      - name: Configure CMake
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            # Gebruik de omgevingsvariabele voor het pad naar vcpkg (veiliger)
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
          else
            # Mac heeft een hint nodig waar sfml@2 staat
            if [ "$RUNNER_OS" == "macOS" ]; then
               export CMAKE_PREFIX_PATH="/opt/homebrew/opt/sfml@2:$CMAKE_PREFIX_PATH"
            fi
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          fi

      # 5. Bouwen
      - name: Build
        run: cmake --build build --config Release

      # 6. Pakketje Maken (Executable + Assets)
      - name: Package Application
        shell: bash
        run: |
          mkdir dist
          
          # Kopieer Assets (Als deze map niet bestaat, faalt de build hier. Zorg dat 'assets' in je repo root staat!)
          if [ -d "assets" ]; then
            cp -r assets dist/
          else
            echo "WARNING: Assets folder not found!"
          fi
          
          # Kopieer Executables en DLLs
          if [ "$RUNNER_OS" == "Windows" ]; then
            cp build/Release/*.exe dist/
            # Probeer DLLs te vinden en mee te kopiÃ«ren (nodig als je niet statisch linkt)
            find build -name "*.dll" -exec cp {} dist/ \;
          else
            # Linux/Mac: Vind de executable (zonder extensie) en kopieer hem
            find build -maxdepth 3 -type f -executable -not -path '*/.*' -exec cp {} dist/ \;
          fi
          
          # Comprimeer de map
          cd dist
          if [ "$RUNNER_OS" == "Windows" ]; then
            7z a ../${{ matrix.artifact_name }}${{ matrix.asset_ext }} *
          else
            tar -czvf ../${{ matrix.artifact_name }}${{ matrix.asset_ext }} *
          fi

      # 7. Uploaden naar GitHub Releases
      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.artifact_name }}${{ matrix.asset_ext }}
